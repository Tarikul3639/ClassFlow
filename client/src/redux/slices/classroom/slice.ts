import { createSlice } from "@reduxjs/toolkit";
import { ClassroomState } from "@/redux/slices/classroom/types";

// Thunks of classroom
import { fetchClassroomDetails } from "./thunks/classroom/fetchClassroomDetails";
import { createClassroomThunk } from "./thunks/classroom/createClassroomThunk";
import { joinClassroomThunk } from "./thunks/classroom/joinClassroomThunk";
import { leaveClassroomThunk } from "./thunks/classroom/leaveClassroomThunk";

// Thunks of events
import { createEventThunk } from "./thunks/event/createEventThunk";
import { updateEventThunk } from "./thunks/event/updateEventThunk";
import { deleteEventThunk } from "./thunks/event/deleteEventThunk";
import { set } from "date-fns";

const initialState: ClassroomState = {
  classroom: null,
  loading: false,
  error: null,
  requestStatus: {
    // Classroom related statuses
    fetchClassroom: { loading: false, error: null },
    joinClassroom: { loading: false, error: null },
    leaveClassroom: { loading: false, error: null },
    createClassroom: { loading: false, error: null },
    // Event related statuses
    fetchEvents: { loading: false, error: null },
    updateEvent: { loading: false, error: null },
    deleteEvent: { loading: false, error: null },
    createEvent: { loading: false, error: null },
  },
};

const classroomSlice = createSlice({
  name: "classroom",
  initialState,
  reducers: {
    // Set error for createClassroom
    setCreateClassroomError(state, action) {
      state.requestStatus.createClassroom.error = action.payload;
    },
    // Set error for joinClassroom
    setJoinClassroomError(state, action) {
      state.requestStatus.joinClassroom.error = action.payload;
    },
    // Set error for leaveClassroom
    setLeaveClassroomError(state, action) {
      state.requestStatus.leaveClassroom.error = action.payload;
    },
    // Ser error for Delete Event
    setDeleteEventError(state, action) {
      state.requestStatus.deleteEvent.error = action.payload;
    },
    // Set error for Update Event
    setUpdateEventError(state, action) {
      state.requestStatus.updateEvent.error = action.payload;
    },
    // Set Mark as a Prepared
    setMarkEventAsPrepared(state, action) {
      state.classroom?.events.includes(action.payload.eventId) &&
        (state.classroom.events.find(
          (e) => e._id === action.payload.eventId,
        )!.isCompleted = action.payload.isCompleted);
    },
  },
  extraReducers: (builder) => {
    //----------------------------------------------
    // ------------Classroom Thunks-------------------
    //----------------------------------------------

    // Fetch User Classrooms
    builder
      .addCase(fetchClassroomDetails.pending, (state) => {
        state.requestStatus.fetchClassroom.loading = true;
        state.requestStatus.fetchClassroom.error = null;
      })
      .addCase(fetchClassroomDetails.fulfilled, (state, action) => {
        state.requestStatus.fetchClassroom.loading = false;
        state.classroom = action.payload;
      })
      .addCase(fetchClassroomDetails.rejected, (state, action) => {
        state.requestStatus.fetchClassroom.loading = false;
        state.requestStatus.fetchClassroom.error = action.payload as string;
      });

    // Create Classroom
    builder
      .addCase(createClassroomThunk.pending, (state) => {
        state.requestStatus.createClassroom.loading = true;
        state.requestStatus.createClassroom.error = null;
      })
      .addCase(createClassroomThunk.fulfilled, (state, action) => {
        state.requestStatus.createClassroom.loading = false;
        state.classroom = action.payload;
      })
      .addCase(createClassroomThunk.rejected, (state, action) => {
        state.requestStatus.createClassroom.loading = false;
        state.requestStatus.createClassroom.error = action.payload as string;
      });

    // Join Classroom
    builder
      .addCase(joinClassroomThunk.pending, (state) => {
        state.requestStatus.joinClassroom.loading = true;
        state.requestStatus.joinClassroom.error = null;
      })
      .addCase(joinClassroomThunk.fulfilled, (state, action) => {
        state.requestStatus.joinClassroom.loading = false;

        state.classroom = action.payload;
      })
      .addCase(joinClassroomThunk.rejected, (state, action) => {
        state.requestStatus.joinClassroom.loading = false;
        state.requestStatus.joinClassroom.error = action.payload as string;
      });

    // Leave Classroom
    builder
      .addCase(leaveClassroomThunk.pending, (state) => {
        state.requestStatus.leaveClassroom.loading = true;
        state.requestStatus.leaveClassroom.error = null;
      })
      .addCase(leaveClassroomThunk.fulfilled, (state, action) => {
        state.requestStatus.leaveClassroom.loading = false;
        state.classroom = null;
      })
      .addCase(leaveClassroomThunk.rejected, (state, action) => {
        state.requestStatus.leaveClassroom.loading = false;
        state.requestStatus.leaveClassroom.error = action.payload as string;
      });

    //----------------------------------------------
    // ------------------Event Thunks-------------------
    //----------------------------------------------

    // Create Event
    builder
      .addCase(createEventThunk.pending, (state) => {
        state.requestStatus.createEvent.loading = true;
        state.requestStatus.createEvent.error = null;
      })
      .addCase(createEventThunk.fulfilled, (state, action) => {
        state.requestStatus.createEvent.loading = false;
        if (state.classroom) {
          state.classroom.events.push(action.payload);
          state.classroom.totalEvents += 1;
        }
      })
      .addCase(createEventThunk.rejected, (state, action) => {
        state.requestStatus.createEvent.loading = false;
        state.requestStatus.createEvent.error = action.payload as string;
      });

    // Update Event
    builder
      .addCase(updateEventThunk.pending, (state) => {
        state.requestStatus.updateEvent.loading = true;
        state.requestStatus.updateEvent.error = null;
      })
      .addCase(updateEventThunk.fulfilled, (state, action) => {
        state.requestStatus.updateEvent.loading = false;
        if (state.classroom) {
          const index = state.classroom.events.findIndex(
            (event) => event._id === action.payload._id,
          );
          if (index !== -1) {
            state.classroom.events[index] = action.payload;
          }
        }
      })
      .addCase(updateEventThunk.rejected, (state, action) => {
        state.requestStatus.updateEvent.loading = false;
        state.requestStatus.updateEvent.error = action.payload as string;
      });

    // Delete Event
    builder
      .addCase(deleteEventThunk.pending, (state, action) => {
        state.requestStatus.deleteEvent.loading = true;
        state.requestStatus.deleteEvent.error = null;
      })
      .addCase(deleteEventThunk.fulfilled, (state, action) => {
        state.requestStatus.deleteEvent.loading = false;

        if (!state.classroom) return;

        state.classroom.events = state.classroom.events.filter(
          (e) => e._id !== action.payload,
        );
      })
      .addCase(deleteEventThunk.rejected, (state, action) => {
        state.requestStatus.deleteEvent.loading = false;
        state.requestStatus.deleteEvent.error = action.payload as string;
      });
  },
});

export const {
  setCreateClassroomError,
  setJoinClassroomError,
  setLeaveClassroomError,
  setDeleteEventError,
  setUpdateEventError,
  setMarkEventAsPrepared,
} = classroomSlice.actions;

export default classroomSlice.reducer;
